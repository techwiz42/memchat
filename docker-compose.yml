services:
  postgres:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_USER: memchat
      POSTGRES_DB: memchat
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memchat"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend:
    build: ./backend
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://memchat@postgres:5432/memchat
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      REDIS_URL: redis://redis:6379/0
      OMNIA_API_KEY_FILE: /run/secrets/omnia_api_key
      LLM_API_KEY_FILE: /run/secrets/llm_api_key
      EMBEDDING_API_KEY_FILE: /run/secrets/embedding_api_key
      APP_SECRET_KEY_FILE: /run/secrets/app_secret_key
      GOOGLE_CLIENT_ID_FILE: /run/secrets/google_client_id
      GOOGLE_CLIENT_SECRET_FILE: /run/secrets/google_client_secret
      GOOGLE_API_KEY_FILE: /run/secrets/google_api_key
      GOOGLE_SEARCH_ENGINE_ID_FILE: /run/secrets/google_search_engine_id
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-http://localhost:8000}
      OMNIA_VOICE_NAME: ${OMNIA_VOICE_NAME:-Mark}
      OMNIA_LANGUAGE_CODE: ${OMNIA_LANGUAGE_CODE:-en}
      LLM_MODEL: ${LLM_MODEL:-gpt-4o}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      EMBEDDING_DIMENSIONS: ${EMBEDDING_DIMENSIONS:-1536}
      YOLO_MODEL: ${YOLO_MODEL:-yolov8n.pt}
      YOLO_CONFIDENCE: ${YOLO_CONFIDENCE:-0.35}
      VISION_CHANGE_COOLDOWN: ${VISION_CHANGE_COOLDOWN:-10}
    volumes:
      - yolo_models:/root/.ultralytics
    secrets:
      - omnia_api_key
      - llm_api_key
      - embedding_api_key
      - postgres_password
      - app_secret_key
      - google_client_id
      - google_client_secret
      - google_api_key
      - google_search_engine_id
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  frontend:
    build: ./frontend
    restart: unless-stopped
    depends_on:
      - backend

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "127.0.0.1:9090:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend

secrets:
  omnia_api_key:
    file: ./secrets/omnia_api_key
  llm_api_key:
    file: ./secrets/llm_api_key
  embedding_api_key:
    file: ./secrets/embedding_api_key
  postgres_password:
    file: ./secrets/postgres_password
  app_secret_key:
    file: ./secrets/app_secret_key
  google_client_id:
    file: ./secrets/google_client_id
  google_client_secret:
    file: ./secrets/google_client_secret
  google_api_key:
    file: ./secrets/google_api_key
  google_search_engine_id:
    file: ./secrets/google_search_engine_id

volumes:
  pgdata:
  yolo_models:
